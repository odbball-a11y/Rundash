<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="RunDash">
<meta name="theme-color" content="#06061a">
<title>Running Performance Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{background:#06061a}
body{font-family:'DM Sans',sans-serif;background:linear-gradient(180deg,#06061a,#0a0a1a);color:#f0f0f0;
max-width:440px;margin:0 auto;min-height:100vh;min-height:100dvh;padding:0 16px 40px;
-webkit-font-smoothing:antialiased;padding-top:env(safe-area-inset-top)}
.mono{font-family:'JetBrains Mono',monospace}

/* Header */
.hdr{padding:24px 0 8px;display:flex;justify-content:space-between;align-items:center}
.hdr-sub{font-size:10px;color:#555;text-transform:uppercase;letter-spacing:2px}
.hdr-title{font-size:22px;font-weight:700;margin-top:4px;color:#e8dcc8}
.toggle{display:flex;gap:4px;background:#111122;border-radius:8px;padding:3px}
.toggle button{padding:6px 12px;border-radius:6px;border:none;cursor:pointer;background:transparent;
color:#555;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;font-family:'DM Sans',sans-serif}
.toggle button.active{background:#1a1a3e;color:#e8dcc8}

/* Refresh bar */
.refresh-bar{display:flex;gap:8px;margin:12px 0 4px;align-items:center}
.refresh-bar .btn-ref{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #1a1a2e;
background:#0d0d1a;color:#e8dcc8;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;
cursor:pointer;text-align:center;transition:all .15s ease;display:flex;align-items:center;justify-content:center;gap:6px}
.refresh-bar .btn-ref:hover{background:#111128;border-color:#2a2a4e}
.refresh-bar .btn-ref:active{transform:scale(.97)}
.refresh-bar .btn-ref.loading{opacity:.6;pointer-events:none}
.refresh-bar .btn-ref .spinner{display:none;width:14px;height:14px;border:2px solid #333;
border-top-color:#e8dcc8;border-radius:50%;animation:spin .6s linear infinite}
.refresh-bar .btn-ref.loading .spinner{display:inline-block}
.refresh-bar .btn-ref.loading .btn-icon{display:none}
@keyframes spin{to{transform:rotate(360deg)}}
.status-toast{font-size:11px;color:#555;text-align:center;margin-bottom:8px;min-height:16px;transition:color .3s}
.status-toast.ok{color:#22c55e}
.status-toast.err{color:#ef4444}

/* API Key modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;
align-items:center;justify-content:center;padding:24px}
.modal-overlay.show{display:flex}
.modal{background:#0d0d2a;border:1px solid #1a1a2e;border-radius:16px;padding:24px;max-width:380px;width:100%}
.modal h3{color:#e8dcc8;font-size:16px;margin-bottom:12px}
.modal p{color:#888;font-size:12px;line-height:1.6;margin-bottom:16px}
.modal input{width:100%;padding:10px 14px;border-radius:8px;border:1px solid #1a1a2e;background:#06061a;
color:#f0f0f0;font-family:'JetBrains Mono',monospace;font-size:12px;margin-bottom:12px}
.modal input::placeholder{color:#333}
.modal .modal-btns{display:flex;gap:8px}
.modal .modal-btns button{flex:1;padding:10px;border-radius:8px;border:none;cursor:pointer;
font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600}
.modal .btn-save{background:#1a1a3e;color:#e8dcc8}
.modal .btn-cancel{background:transparent;border:1px solid #1a1a2e !important;color:#666}
.modal .btn-danger{background:rgba(239,68,68,.15);color:#ef4444}
.modal .api-status{font-size:11px;margin-bottom:12px;padding:8px 12px;border-radius:8px}
.modal .api-status.configured{background:rgba(34,197,94,.1);color:#22c55e}
.modal .api-status.not-configured{background:rgba(245,158,11,.1);color:#f59e0b}

/* Score ring */
.hero{display:flex;flex-direction:column;align-items:center;padding:24px 0 16px}
.ring-wrap{position:relative;width:160px;height:160px}
.ring-wrap canvas{width:160px!important;height:160px!important}
.ring-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.ring-num{font-size:42px;font-weight:700;color:#f0f0f0}
.ring-sub{font-size:11px;color:#888;letter-spacing:2px;text-transform:uppercase;margin-top:-4px}
.status-row{margin-top:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center}
.badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
.badge-green{background:rgba(34,197,94,.15);color:#22c55e}
.badge-amber{background:rgba(245,158,11,.15);color:#f59e0b}
.badge-red{background:rgba(239,68,68,.15);color:#ef4444}
.delta{font-size:12px;font-weight:600}
.delta-up{color:#22c55e}
.delta-down{color:#ef4444}

/* AI Summary */
.ai-box{background:linear-gradient(135deg,#0d0d2a,#111128);border-radius:16px;padding:18px 20px;
margin-bottom:20px;border-left:3px solid #e8dcc8}
.ai-label{font-size:10px;color:#e8dcc8;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px}
.ai-text{font-size:13.5px;line-height:1.65;color:#bbb}

/* Pill row */
.pills{display:flex;gap:8px;margin-bottom:8px}
.pill{background:#111122;border-radius:12px;padding:10px 14px;flex:1;min-width:0}
.pill-label{font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px}
.pill-val{font-size:20px;font-weight:700}
.pill-sub{font-size:10px;color:#555;margin-top:2px}

/* Micro indicators */
.micros{display:flex;justify-content:space-around;margin:16px 0 24px;padding:12px 0;
background:#0a0a18;border-radius:12px;border:1px solid #111}
.micro{text-align:center}
.micro-icon{font-size:20px}
.micro-label{font-size:9px;color:#555;text-transform:uppercase;letter-spacing:1px;margin-top:2px}
.micro-val{font-size:11px;font-weight:600;margin-top:2px}

/* Collapsible sections */
.section{margin-bottom:16px}
.section-btn{width:100%;display:flex;justify-content:space-between;align-items:center;
background:#0d0d1a;border:1px solid #1a1a2e;border-radius:12px;padding:14px 16px;
color:#ccc;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600}
.section-arrow{color:#555;font-size:18px;transition:transform .2s}
.section-arrow.open{transform:rotate(180deg)}
.section-body{margin-top:8px;background:#0a0a18;border-radius:12px;padding:16px;border:1px solid #111;
display:none;overflow:hidden}
.section-body.open{display:block}
.chart-wrap{position:relative;width:100%;height:200px}
.chart-wrap canvas{width:100%!important}

/* Segments */
.seg-row{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid #111}
.seg-row:last-child{border-bottom:none}
.seg-name{width:60px;font-weight:700;color:#e8dcc8;font-size:13px}
.seg-mid{flex:1}
.seg-time{font-size:22px;font-weight:700;color:#f0f0f0}
.seg-pace{font-size:10px;color:#666;margin-top:2px}
.seg-right{text-align:right}
.seg-date{font-size:11px;color:#888}
.seg-source{font-size:10px;color:#555}

/* Chart legend */
.legend{display:flex;justify-content:center;gap:16px;margin-top:8px}
.legend-item{display:flex;align-items:center;gap:4px}
.legend-dot{width:8px;height:8px;border-radius:4px}
.legend-text{font-size:10px;color:#666}

/* Footer */
.footer{margin-top:24px;padding:16px 20px;background:#0a0a18;border-radius:12px;border:1px solid #111;
display:flex;justify-content:space-between}
.footer-label{font-size:10px;color:#555;text-transform:uppercase;letter-spacing:1px}
.footer-val{font-size:18px;font-weight:700;color:#e8dcc8}
.footer-small{font-size:13px;color:#888;margin-top:4px}
.foot-note{text-align:center;margin-top:20px;font-size:10px;color:#333}
.chart-note{font-size:11px;color:#666;margin-bottom:8px}

/* Loading state */
.loading-state{display:flex;flex-direction:column;align-items:center;justify-content:center;
min-height:60vh;gap:16px}
.loading-state .big-spinner{width:40px;height:40px;border:3px solid #1a1a2e;
border-top-color:#e8dcc8;border-radius:50%;animation:spin .8s linear infinite}
.loading-state p{color:#555;font-size:13px}
#dashboard{display:none}
</style>
</head>
<body>

<!-- Loading state -->
<div class="loading-state" id="loadingState">
  <div class="big-spinner"></div>
  <p>Loading activity dataâ€¦</p>
</div>

<!-- API Key Modal -->
<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <h3>ğŸ”‘ Runalyze API Key</h3>
    <div class="api-status not-configured" id="apiStatus">No API key configured</div>
    <p>Your API key is used <strong>only</strong> as a fallback for local development. On Netlify, the key is stored securely as an environment variable â€” no browser storage needed.</p>
    <p style="margin-bottom:8px">Find your key in Runalyze: <strong>Settings â†’ API</strong></p>
    <input type="password" id="apiKeyInput" placeholder="Paste your API key hereâ€¦">
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeApiModal()">Cancel</button>
      <button class="btn-danger" onclick="clearApiKey()" style="flex:0.6">Clear</button>
      <button class="btn-save" onclick="saveApiKey()">Save</button>
    </div>
  </div>
</div>

<!-- Dashboard (hidden until data loads) -->
<div id="dashboard">

<!-- Header -->
<div class="hdr">
  <div>
    <div class="hdr-sub">runalyze Â· performance</div>
    <div class="hdr-title">Your Dashboard</div>
  </div>
  <div class="toggle">
    <button class="active" id="btn-daily" onclick="setView('daily')">Daily</button>
    <button id="btn-weekly" onclick="setView('weekly')">Weekly</button>
  </div>
</div>

<!-- Refresh bar -->
<div class="refresh-bar">
  <button class="btn-ref" id="btnCsv" onclick="pickCsvFile()">
    <span class="btn-icon">ğŸ“‚</span><span class="spinner"></span> Load CSV
  </button>
  <button class="btn-ref" id="btnApi" onclick="refreshFromApi()">
    <span class="btn-icon">ğŸ”„</span><span class="spinner"></span> Refresh RHR
  </button>
  <button class="btn-ref" onclick="showApiModal()" style="flex:0;padding:10px 14px">
    <span class="btn-icon">ğŸ”‘</span><span class="spinner"></span>
  </button>
</div>
<div class="status-toast" id="statusToast"></div>

<!-- Hidden file input -->
<input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleCsvFile(event)">

<!-- Hero Score -->
<div class="hero">
  <div class="ring-wrap">
    <canvas id="ringChart" width="160" height="160"></canvas>
    <div class="ring-label">
      <div class="ring-num mono" id="scoreNum">â€”</div>
      <div class="ring-sub">fitness score</div>
    </div>
  </div>
  <div class="status-row">
    <span class="badge badge-green" id="statusBadge">Loadingâ€¦</span>
    <span class="delta delta-up mono" id="deltaText"></span>
  </div>
</div>

<!-- AI Summary -->
<div class="ai-box">
  <div class="ai-label" id="aiLabel">Today's Read</div>
  <div class="ai-text" id="aiText"></div>
</div>

<!-- Quick Stats -->
<div class="pills">
  <div class="pill"><div class="pill-label">Fitness</div><div class="pill-val mono" style="color:#3b82f6" id="pCTL">â€”</div><div class="pill-sub">CTL (42d)</div></div>
  <div class="pill"><div class="pill-label">Fatigue</div><div class="pill-val mono" style="color:#f59e0b" id="pATL">â€”</div><div class="pill-sub">ATL (7d)</div></div>
  <div class="pill"><div class="pill-label">Form</div><div class="pill-val mono" style="color:#ef4444" id="pTSB">â€”</div><div class="pill-sub">TSB</div></div>
</div>
<div class="pills" style="margin-bottom:0">
  <div class="pill"><div class="pill-label">ACWR</div><div class="pill-val mono" id="pACWR" style="color:#22c55e">â€”</div><div class="pill-sub">0.8â€“1.3 optimal</div></div>
  <div class="pill"><div class="pill-label">VOâ‚‚max</div><div class="pill-val mono" style="color:#a78bfa" id="pVO2">â€”</div><div class="pill-sub">5-run avg</div></div>
  <div class="pill"><div class="pill-label">RHR</div><div class="pill-val mono" style="color:#6ee7b7" id="pRHR">â€”</div><div class="pill-sub" id="pRHRsub">bpm today</div></div>
</div>

<!-- Micro Indicators -->
<div class="micros">
  <div class="micro"><div class="micro-icon">â¤ï¸</div><div class="micro-label">HR Drift</div><div class="micro-val" id="mDrift" style="color:#22c55e">â€”</div></div>
  <div class="micro"><div class="micro-icon">âš¡</div><div class="micro-label">Fatigue</div><div class="micro-val" id="mFatigue" style="color:#f59e0b">â€”</div></div>
  <div class="micro"><div class="micro-icon">ğŸ”</div><div class="micro-label">Monotony</div><div class="micro-val" id="mMono" style="color:#22c55e">â€”</div></div>
  <div class="micro"><div class="micro-icon">ğŸ§ </div><div class="micro-label">Ready</div><div class="micro-val" id="mReady" style="color:#22c55e">â€”</div></div>
</div>

<!-- Charts -->
<div class="section">
  <button class="section-btn" onclick="toggleSection(this)">
    <span>ğŸ“ˆ  Fitness vs Fatigue</span><span class="section-arrow open">â–¾</span>
  </button>
  <div class="section-body open">
    <div class="chart-wrap"><canvas id="fitFatChart"></canvas></div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div><span class="legend-text">Fitness</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div><span class="legend-text">Fatigue</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div><span class="legend-text">Form</span></div>
    </div>
  </div>
</div>

<div class="section">
  <button class="section-btn" onclick="toggleSection(this)">
    <span>ğŸ“‰  Aerobic Efficiency Trend</span><span class="section-arrow">â–¾</span>
  </button>
  <div class="section-body">
    <div class="chart-note">Speed (m/s) Ã· Avg HR â€“ higher = fitter</div>
    <div class="chart-wrap"><canvas id="effChart"></canvas></div>
  </div>
</div>

<div class="section">
  <button class="section-btn" onclick="toggleSection(this)">
    <span>ğŸ“Š  Weekly Training Load</span><span class="section-arrow">â–¾</span>
  </button>
  <div class="section-body">
    <div class="chart-wrap"><canvas id="loadChart"></canvas></div>
  </div>
</div>

<div class="section">
  <button class="section-btn" onclick="toggleSection(this)">
    <span>ğŸ«  VOâ‚‚max Trend</span><span class="section-arrow">â–¾</span>
  </button>
  <div class="section-body">
    <div class="chart-wrap"><canvas id="vo2Chart"></canvas></div>
  </div>
</div>

<div class="section">
  <button class="section-btn" onclick="toggleSection(this)">
    <span>ğŸ†  Best Segment Times</span><span class="section-arrow open">â–¾</span>
  </button>
  <div class="section-body open" id="segmentsBody"></div>
</div>

<!-- Footer -->
<div class="footer">
  <div><div class="footer-label">Total Runs</div><div class="footer-val mono" id="fTotal">â€”</div></div>
  <div style="text-align:right"><div class="footer-label">Data Range</div><div class="footer-small" id="fRange">â€”</div></div>
</div>
<div class="foot-note">powered by runalyze Â· built with claude</div>

</div><!-- /dashboard -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let D = null;
let charts = {};
let rhrFromApi = null;
let currentView = 'daily';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pickCsvFile() { document.getElementById('csvInput').click(); }

function handleCsvFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const btn = document.getElementById('btnCsv');
  btn.classList.add('loading');
  toast('Parsing CSVâ€¦');
  Papa.parse(file, {
    header: true, dynamicTyping: true, skipEmptyLines: true,
    complete: (results) => {
      try {
        D = computeFromCsv(results.data);
        renderDashboard();
        toast('âœ“ Dashboard updated from ' + file.name, 'ok');
      } catch (err) {
        toast('âœ— Error: ' + err.message, 'err');
        console.error(err);
      }
      btn.classList.remove('loading');
      e.target.value = '';
    },
    error: () => { toast('âœ— CSV parse error', 'err'); btn.classList.remove('loading'); }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-LOAD CSV from same folder
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function tryAutoLoad() {
  const names = ['runalyzeactivities_1.csv','runalyzeactivities.csv','activities.csv'];
  for (const name of names) {
    try {
      const resp = await fetch(name);
      if (resp.ok) {
        const text = await resp.text();
        const results = Papa.parse(text, { header: true, dynamicTyping: true, skipEmptyLines: true });
        D = computeFromCsv(results.data);
        renderDashboard();
        toast('âœ“ Auto-loaded ' + name, 'ok');
        // Also try to fetch RHR automatically
        refreshFromApi(true);
        return;
      }
    } catch (e) { /* next */ }
  }
  // No CSV â€” show prompt
  document.getElementById('loadingState').innerHTML = `
    <div style="text-align:center;padding:40px 20px">
      <div style="font-size:48px;margin-bottom:16px">ğŸ“‚</div>
      <p style="color:#888;font-size:14px;margin-bottom:8px">No activity CSV found in this folder</p>
      <p style="color:#555;font-size:12px;margin-bottom:20px">Drop your <span class="mono" style="color:#e8dcc8">runalyzeactivities_1.csv</span> next to this HTML file,<br>or click below to load it manually.</p>
      <button onclick="pickCsvFile()" style="padding:12px 24px;border-radius:10px;border:1px solid #1a1a2e;
        background:#0d0d1a;color:#e8dcc8;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer">
        ğŸ“‚ Choose CSV File
      </button>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUNALYZE API â€” Resting Heart Rate
// Strategy: try Netlify function first (/api/rhr), fall back to
// direct API call with local key if that fails.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshFromApi(silent = false) {
  const btn = document.getElementById('btnApi');
  btn.classList.add('loading');
  if (!silent) toast('Fetching RHRâ€¦');

  let data = null;

  // Attempt 1: Netlify function (works on hosted site, no key needed client-side)
  try {
    const resp = await fetch('/api/rhr');
    if (resp.ok) {
      data = await resp.json();
    }
  } catch (e) { /* not on Netlify, try fallback */ }

  // Attempt 2: Direct API with locally stored key (for local dev)
  if (!data) {
    const localKey = localStorage.getItem('runalyze_api_key');
    if (localKey) {
      try {
        const resp = await fetch('https://runalyze.com/api/v1/metrics/heartRateRest?page=1', {
          headers: { 'token': localKey }
        });
        if (resp.ok) data = await resp.json();
      } catch (e) { /* CORS blocked or network error */ }
    }
  }

  if (data && data.data && data.data.length > 0) {
    rhrFromApi = data.data[0].heart_rate;
    const date = data.data[0].date_time.split('T')[0];
    document.getElementById('pRHR').textContent = rhrFromApi;
    document.getElementById('pRHRsub').textContent = 'bpm Â· ' + date;
    if (D) { D.rhr = rhrFromApi; updateAiText(); setView(currentView); }
    if (!silent) toast('âœ“ RHR updated: ' + rhrFromApi + ' bpm', 'ok');
  } else {
    if (!silent) {
      const hasKey = localStorage.getItem('runalyze_api_key');
      if (!hasKey) {
        toast('Set up API key (ğŸ”‘) or deploy to Netlify for live RHR', 'err');
      } else {
        toast('âœ— Could not fetch RHR (CORS blocked â€” deploy to Netlify)', 'err');
      }
    }
  }
  btn.classList.remove('loading');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEY MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showApiModal() {
  const key = localStorage.getItem('runalyze_api_key');
  const status = document.getElementById('apiStatus');
  if (key) {
    status.textContent = 'âœ“ Local fallback key is saved';
    status.className = 'api-status configured';
    document.getElementById('apiKeyInput').placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
  } else {
    status.textContent = 'No local key â€” using Netlify function on hosted site';
    status.className = 'api-status not-configured';
  }
  document.getElementById('apiModal').classList.add('show');
}
function closeApiModal() { document.getElementById('apiModal').classList.remove('show'); }
function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (key) { localStorage.setItem('runalyze_api_key', key); toast('âœ“ API key saved', 'ok'); }
  closeApiModal();
}
function clearApiKey() {
  localStorage.removeItem('runalyze_api_key');
  toast('API key cleared', 'ok');
  closeApiModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type) {
  const el = document.getElementById('statusToast');
  el.textContent = msg;
  el.className = 'status-toast' + (type ? ' ' + type : '');
  if (type) setTimeout(() => { el.textContent = ''; el.className = 'status-toast'; }, 4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPUTE ALL METRICS FROM CSV DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeFromCsv(rows) {
  const runs = rows
    .filter(r => r.sportid === 1094255 && r.time)
    .map(r => ({ ...r, dt: new Date(r.time * 1000) }))
    .sort((a, b) => a.dt - b.dt);
  if (runs.length === 0) throw new Error('No running activities found in CSV');

  // Daily TRIMP
  const dailyTrimp = {};
  runs.forEach(r => { const k = dateKey(r.dt); dailyTrimp[k] = (dailyTrimp[k] || 0) + (r.trimp || 0); });
  const firstDate = new Date(runs[0].dt); firstDate.setHours(0,0,0,0);
  const lastDate = new Date(runs[runs.length-1].dt); lastDate.setHours(0,0,0,0);
  const days = [];
  for (let d = new Date(firstDate); d <= lastDate; d.setDate(d.getDate()+1)) {
    days.push({ date: new Date(d), trimp: dailyTrimp[dateKey(d)] || 0 });
  }

  // EWM CTL/ATL/TSB
  let ctl = 0, atl = 0;
  const alphaCtl = 2/43, alphaAtl = 2/8;
  days.forEach(d => {
    ctl = ctl * (1-alphaCtl) + d.trimp * alphaCtl;
    atl = atl * (1-alphaAtl) + d.trimp * alphaAtl;
    d.ctl = ctl; d.atl = atl; d.tsb = ctl - atl;
  });
  const latest = days[days.length-1];

  // ACWR
  const now = latest.date;
  const weekAgo = new Date(now); weekAgo.setDate(weekAgo.getDate()-7);
  const fourWeeksAgo = new Date(now); fourWeeksAgo.setDate(fourWeeksAgo.getDate()-28);
  const acute = days.filter(d => d.date > weekAgo).reduce((s,d) => s+d.trimp, 0) / 7;
  const chronic = days.filter(d => d.date > fourWeeksAgo && d.date <= now).reduce((s,d) => s+d.trimp, 0) / 28;
  const acwr = chronic > 0 ? round2(acute/chronic) : 0;

  // Fitness chart (last ~3 months on run dates)
  const threeMonthsAgo = new Date(now); threeMonthsAgo.setMonth(threeMonthsAgo.getMonth()-3);
  const recentRunDates = new Set(runs.filter(r => r.dt >= threeMonthsAgo).map(r => dateKey(r.dt)));
  const fitnessData = days.filter(d => recentRunDates.has(dateKey(d.date))).slice(-35)
    .map(d => ({ d: fmtMD(d.date), fit: round1(d.ctl), fat: round1(d.atl), form: round1(d.tsb) }));

  // VO2max
  const vo2Runs = runs.filter(r => r.vo2max > 0);
  const sixMonthsAgo = new Date(now); sixMonthsAgo.setMonth(sixMonthsAgo.getMonth()-6);
  const vo2Data = vo2Runs.filter(r => r.dt >= sixMonthsAgo).map(r => ({ d: fmtMD(r.dt), v: round1(r.vo2max) }));
  const last5Vo2 = round1(vo2Runs.slice(-5).reduce((s,r) => s+r.vo2max, 0) / Math.min(5, vo2Runs.length));

  // Efficiency
  const effRuns = runs.filter(r => r.dt >= sixMonthsAgo && r.pulseAvg > 0 && r.distance > 1);
  const effData = effRuns.map(r => {
    const eff = ((r.distance*1000/r.s) / r.pulseAvg) * 1000;
    const pt = r.s/60/r.distance; const pm = Math.floor(pt), ps = Math.floor((pt-pm)*60);
    return { d: fmtMD(r.dt), v: round1(eff), p: pm+':'+String(ps).padStart(2,'0'), hr: r.pulseAvg };
  });

  // Weekly load (last ~4 months)
  const loadStart = new Date(now); loadStart.setMonth(loadStart.getMonth()-4);
  const weeklyMap = {};
  runs.filter(r => r.dt >= loadStart).forEach(r => {
    const wk = getWeekStart(r.dt).toISOString();
    if (!weeklyMap[wk]) weeklyMap[wk] = { date: new Date(wk), trimp: 0 };
    weeklyMap[wk].trimp += (r.trimp || 0);
  });
  const weeklyLoad = Object.values(weeklyMap).sort((a,b) => a.date-b.date)
    .map(w => ({ w: fmtShort(w.date), l: Math.round(w.trimp) }));

  // Best segments
  const segments = [];
  [['1km',1],['1 mile',1.609],['3km',3],['5km',5],['10km',10]].forEach(([name,dist]) => {
    const best = findBestSegment(runs, dist);
    if (best) { best.name = name; segments.push(best); }
  });

  // Fitness score
  const vo2Score = Math.min(100, (last5Vo2/50)*100);
  const ctlScore = Math.min(100, (latest.ctl/40)*100);
  const consistency = Math.min(100, (runs.filter(r => r.dt >= new Date(now.getTime()-28*864e5)).length/12)*100);
  const acwrScore = (acwr >= 0.8 && acwr <= 1.3) ? 100 : 60;
  const fitnessScore = Math.round(vo2Score*.3 + ctlScore*.3 + consistency*.2 + acwrScore*.2);

  // Delta
  const weekAgoDay = days.find(d => dateKey(d.date) === dateKey(weekAgo));
  const delta = weekAgoDay ? round1(latest.ctl - weekAgoDay.ctl) : 0;

  // Status
  let status;
  if (latest.tsb < -20) status = 'Overreaching';
  else if (latest.tsb < -10) status = 'Absorbing Load';
  else if (latest.tsb < 0) status = 'Productive Training';
  else if (latest.tsb < 10) status = 'Fresh';
  else status = 'Detraining Risk';

  // Micros
  const lastRun = runs[runs.length-1];
  const ad = lastRun.aerobicDecouplingPace;
  const hrDriftHigh = ad && Math.abs(ad) > 10;
  const fatElevated = latest.atl > latest.ctl;
  const last7 = runs.filter(r => r.dt >= new Date(now.getTime()-7*864e5));
  const t7 = last7.map(r => r.trimp||0);
  const meanT = t7.reduce((s,v)=>s+v,0)/(t7.length||1);
  const stdT = Math.sqrt(t7.reduce((s,v)=>s+(v-meanT)**2,0)/(t7.length||1));
  const mono = stdT > 0 ? meanT/stdT : 0;
  const monoS = mono < 1.5 ? 'Low' : mono < 2 ? 'Moderate' : 'High';
  const readyOk = latest.tsb > -15 && latest.tsb < 5 && acwr < 1.3;

  // For AI text
  const twoWeeksAgo = new Date(now); twoWeeksAgo.setDate(twoWeeksAgo.getDate()-14);
  const thisWeekTrimp = last7.reduce((s,r)=>s+(r.trimp||0),0);
  const lastWeekTrimp = runs.filter(r => r.dt >= twoWeeksAgo && r.dt < weekAgo).reduce((s,r)=>s+(r.trimp||0),0);
  const recentEff = effData.slice(-5), olderEff = effData.slice(-10,-5);
  const hrImprovement = Math.round(
    (olderEff.reduce((s,e)=>s+e.hr,0)/(olderEff.length||1)) -
    (recentEff.reduce((s,e)=>s+e.hr,0)/(recentEff.length||1))
  );

  return {
    fitnessScore, status, delta,
    ctl: round1(latest.ctl), atl: round1(latest.atl), tsb: round1(latest.tsb),
    acwr, vo2: last5Vo2, rhr: rhrFromApi || null,
    totalRuns: runs.length,
    dateMin: fmtMonthYear(runs[0].dt), dateMax: fmtMonthYear(runs[runs.length-1].dt),
    fitnessData, effData, vo2Data, weeklyLoad, segments,
    micros: {
      hrDrift: { status: hrDriftHigh?'High':'Stable', color: hrDriftHigh?'#f59e0b':'#22c55e' },
      fatigue: { status: fatElevated?'Elevated':'Managed', color: fatElevated?'#f59e0b':'#22c55e' },
      monotony: { status: monoS, color: monoS==='Low'?'#22c55e':monoS==='Moderate'?'#f59e0b':'#ef4444' },
      ready: { status: readyOk?'Good':'Caution', color: readyOk?'#22c55e':'#f59e0b' }
    },
    lastRunHr: lastRun.pulseAvg,
    lastRunDay: ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][lastRun.dt.getDay()],
    thisWeekTrimp, lastWeekTrimp, hrImprovement
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEST SEGMENT FINDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function findBestSegment(runs, targetKm) {
  let bestTime = Infinity, bestDate = '', bestTitle = '', bestDist = 0;
  runs.forEach(run => {
    const splits = parseSplits(run.splits);
    if (!splits.length) return;
    for (let start = 0; start < splits.length; start++) {
      let cumDist = 0, cumTime = 0;
      for (let end = start; end < splits.length; end++) {
        cumDist += splits[end][0]; cumTime += splits[end][1];
        if (cumDist >= targetKm * 0.98) {
          const adjusted = cumTime * (targetKm / cumDist);
          if (adjusted < bestTime) {
            bestTime = adjusted; bestDate = run.dt.toISOString().split('T')[0];
            bestTitle = String(run.title || ''); bestDist = run.distance;
          }
          break;
        }
      }
    }
  });
  if (bestTime < Infinity) {
    const mins = Math.floor(bestTime/60), secs = Math.floor(bestTime%60);
    const pace = bestTime/targetKm, pm = Math.floor(pace/60), ps = Math.floor(pace%60);
    const t = bestTitle.includes(' - ') ? bestTitle.split(' - ').pop() : bestTitle;
    return { time: mins+':'+String(secs).padStart(2,'0'), date: bestDate, title: t,
      dist: Math.round(bestDist*10)/10, pace: pm+':'+String(ps).padStart(2,'0')+'/km' };
  }
  return null;
}

function parseSplits(str) {
  if (!str || typeof str !== 'string') return [];
  return str.split('-').map(seg => {
    try {
      const [dp, tp] = seg.split('|');
      return [parseFloat(dp.substring(1)), tp.split(':').map(Number).reduce((a,b)=>a*60+b)];
    } catch { return null; }
  }).filter(Boolean);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';

  // Ring
  destroyChart('ringChart');
  const ringColor = D.fitnessScore >= 70 ? '#22c55e' : D.fitnessScore >= 50 ? '#f59e0b' : '#ef4444';
  charts.ring = new Chart(document.getElementById('ringChart'), {
    type:'doughnut', data:{ datasets:[{ data:[D.fitnessScore,100-D.fitnessScore],
    backgroundColor:[ringColor,'#1a1a2e'], borderWidth:0, borderRadius:6 }] },
    options:{ cutout:'78%', responsive:false, plugins:{ tooltip:{enabled:false} } }
  });

  document.getElementById('scoreNum').textContent = D.fitnessScore;
  const badge = document.getElementById('statusBadge');
  badge.textContent = D.status;
  badge.className = 'badge '+({'Productive Training':'badge-green','Fresh':'badge-green',
    'Absorbing Load':'badge-amber','Overreaching':'badge-red','Detraining Risk':'badge-red'}[D.status]||'badge-amber');
  const de = document.getElementById('deltaText');
  de.textContent = (D.delta>=0?'â†‘ ':'â†“ ')+Math.abs(D.delta)+' vs last week';
  de.className = 'delta mono '+(D.delta>=0?'delta-up':'delta-down');

  document.getElementById('pCTL').textContent = D.ctl;
  document.getElementById('pATL').textContent = D.atl;
  document.getElementById('pTSB').textContent = D.tsb;
  const ae = document.getElementById('pACWR');
  ae.textContent = D.acwr; ae.style.color = (D.acwr>=0.8&&D.acwr<=1.3)?'#22c55e':'#f59e0b';
  document.getElementById('pVO2').textContent = D.vo2;
  document.getElementById('pRHR').textContent = D.rhr || 'â€”';
  document.getElementById('pRHRsub').textContent = D.rhr ? 'bpm today' : 'tap ğŸ”„ to fetch';

  setMicro('mDrift',D.micros.hrDrift); setMicro('mFatigue',D.micros.fatigue);
  setMicro('mMono',D.micros.monotony); setMicro('mReady',D.micros.ready);

  renderFitFatChart(); renderEffChart(); renderLoadChart(); renderVo2Chart(); renderSegments();

  document.getElementById('fTotal').textContent = D.totalRuns;
  document.getElementById('fRange').textContent = D.dateMin+' â€“ '+D.dateMax;

  updateAiText(); setView(currentView);
}

function setMicro(id,data) { const e=document.getElementById(id); e.textContent=data.status; e.style.color=data.color; }

function updateAiText() {
  const rhrText = D.rhr ? ` RHR is ${D.rhr} bpm.` : '';
  D._aiDaily = `Training load is productively managed with an ACWR of ${D.acwr}, sitting in the optimal range. Your last run (${D.lastRunDay}) showed solid efficiency at ${D.lastRunHr} bpm average. Fitness (CTL) at ${D.ctl} â€” up ${D.delta} from last week.${rhrText} Today suits an easy run or light tempo work.`;
  D._aiWeekly = `Fitness improved by ${D.delta} points this week. Weekly load was ${D.thisWeekTrimp} TRIMP vs ${D.lastWeekTrimp} last week. Aerobic efficiency has been trending upward, with heart rates at similar paces dropping by ~${D.hrImprovement} bpm over the past fortnight. VOâ‚‚max 5-run average sits at ${D.vo2}.${rhrText} Maintain current volume and consider one lighter day mid-week.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function destroyChart(id) { if(charts[id]){charts[id].destroy();delete charts[id];} }
const cBase = { responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
  scales:{ x:{grid:{color:'#111'},ticks:{maxTicksLimit:8}}, y:{grid:{color:'#111'}} } };

function renderFitFatChart() {
  destroyChart('fitFat');
  charts.fitFat = new Chart(document.getElementById('fitFatChart'), { type:'line', data:{
    labels:D.fitnessData.map(d=>d.d), datasets:[
      {label:'Fitness',data:D.fitnessData.map(d=>d.fit),borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:.3,pointRadius:0,borderWidth:2},
      {label:'Fatigue',data:D.fitnessData.map(d=>d.fat),borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.05)',fill:true,tension:.3,pointRadius:0,borderWidth:2},
      {label:'Form',data:D.fitnessData.map(d=>d.form),borderColor:'#22c55e',borderDash:[4,4],tension:.3,pointRadius:0,borderWidth:1.5,fill:false}
    ]}, options:{...cBase} });
}

function renderEffChart() {
  destroyChart('eff');
  charts.eff = new Chart(document.getElementById('effChart'), { type:'line', data:{
    labels:D.effData.map(d=>d.d), datasets:[{
      label:'Efficiency (Ã—1000)',data:D.effData.map(d=>d.v),
      borderColor:'#a78bfa',backgroundColor:'rgba(167,139,250,.1)',fill:true,
      tension:.3,pointRadius:3,pointBackgroundColor:'#a78bfa',borderWidth:2
    }]}, options:{...cBase,
      scales:{...cBase.scales,y:{grid:{color:'#111'},min:13,max:23}},
      plugins:{tooltip:{callbacks:{label:ctx=>{const d=D.effData[ctx.dataIndex];
        return['Eff: '+d.v.toFixed(1),'Pace: '+d.p+' min/km','HR: '+d.hr+' bpm'];}}}}
    } });
}

function renderLoadChart() {
  destroyChart('load');
  charts.load = new Chart(document.getElementById('loadChart'), { type:'bar', data:{
    labels:D.weeklyLoad.map(d=>d.w), datasets:[{label:'TRIMP',data:D.weeklyLoad.map(d=>d.l),
    backgroundColor:'#3b82f6',borderRadius:4,maxBarThickness:28}]},
    options:{responsive:true,maintainAspectRatio:false,
      scales:{x:{grid:{display:false},ticks:{maxTicksLimit:8}},y:{grid:{color:'#111'}}}} });
}

function renderVo2Chart() {
  destroyChart('vo2');
  charts.vo2 = new Chart(document.getElementById('vo2Chart'), { type:'line', data:{
    labels:D.vo2Data.map(d=>d.d), datasets:[{
      label:'VOâ‚‚max',data:D.vo2Data.map(d=>d.v),
      borderColor:'#6ee7b7',backgroundColor:'rgba(110,231,183,.08)',fill:true,
      tension:.3,pointRadius:2.5,pointBackgroundColor:'#6ee7b7',borderWidth:2
    }]}, options:{...cBase,scales:{...cBase.scales,y:{grid:{color:'#111'},min:28,max:52}}} });
}

function renderSegments() {
  document.getElementById('segmentsBody').innerHTML =
    `<div class="chart-note">Extracted from all ${D.totalRuns} runs Â· Finds your fastest splits within any activity</div>`+
    D.segments.map(s=>`<div class="seg-row"><div class="seg-name mono">${s.name}</div>
      <div class="seg-mid"><div class="seg-time mono">${s.time}</div><div class="seg-pace">${s.pace}</div></div>
      <div class="seg-right"><div class="seg-date">${s.date}</div><div class="seg-source">in ${s.dist}km ${s.title}</div></div></div>`).join('')+
    `<div style="margin-top:12px;font-size:10px;color:#444;font-style:italic">Times found by scanning split data across your entire history.</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW / SECTION TOGGLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setView(v) {
  currentView = v;
  document.getElementById('btn-daily').className = v==='daily'?'active':'';
  document.getElementById('btn-weekly').className = v==='weekly'?'active':'';
  document.getElementById('aiLabel').textContent = v==='daily'?"Today's Read":"This Week";
  if(D&&D._aiDaily) document.getElementById('aiText').textContent = v==='daily'?D._aiDaily:D._aiWeekly;
}
function toggleSection(btn) {
  btn.nextElementSibling.classList.toggle('open');
  btn.querySelector('.section-arrow').classList.toggle('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dateKey(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function fmtMD(d){return String(d.getMonth()+1).padStart(2,'0')+'/'+String(d.getDate()).padStart(2,'0')}
function fmtShort(d){return['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()]+' '+String(d.getDate()).padStart(2,'0')}
function fmtMonthYear(d){return['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()]+' '+d.getFullYear()}
function getWeekStart(d){const r=new Date(d);r.setDate(r.getDate()-r.getDay()+1);r.setHours(0,0,0,0);return r}
function round1(v){return Math.round(v*10)/10}
function round2(v){return Math.round(v*100)/100}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART DEFAULTS & INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Chart.defaults.color='#444'; Chart.defaults.borderColor='#111';
Chart.defaults.font.family="'DM Sans', sans-serif"; Chart.defaults.font.size=10;
Chart.defaults.plugins.legend.display=false;
Chart.defaults.plugins.tooltip.backgroundColor='#111122';
Chart.defaults.plugins.tooltip.borderColor='#222'; Chart.defaults.plugins.tooltip.borderWidth=1;
Chart.defaults.plugins.tooltip.cornerRadius=8; Chart.defaults.plugins.tooltip.padding=10;
Chart.defaults.plugins.tooltip.titleFont={family:"'DM Sans', sans-serif",size:11};
Chart.defaults.plugins.tooltip.bodyFont={family:"'JetBrains Mono', monospace",size:11};

tryAutoLoad();
</script>
</body>
</html>
